<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Ashes | Ramadan Tracker</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒ™</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Reem+Kufi:wght@400;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ashes: { 950: '#050505', 900: '#121212', 800: '#1e1e1e', 700: '#2d2d2d' },
                        gold: { 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706' },
                        emerald: { 400: '#34d399', 500: '#10b981', 900: '#064e3b' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], serif: ['Amiri', 'serif'], arabic: ['Reem Kufi', 'sans-serif'] },
                    animation: { 'spin-slow': 'spin 15s linear infinite' }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen relative overflow-x-hidden selection:bg-gold-500 selection:text-black bg-ashes-950 text-gray-200">

    <!-- Background -->
    <div class="fixed inset-0 islamic-pattern pointer-events-none z-0"></div>
    <div class="fixed top-0 left-0 right-0 h-48 bg-gradient-to-b from-gold-600/10 via-ashes-950/50 to-transparent pointer-events-none z-0"></div>

    <!-- Auth Screen -->
    <div id="authScreen" class="relative z-10 flex flex-col items-center justify-center min-h-screen p-6">
        <div class="glass-panel p-10 rounded-3xl shadow-2xl max-w-sm w-full text-center border border-gold-600/30 gold-glow">
            <div class="mb-8">
                <!-- LOGO PLACEHOLDER -->
                <div class="w-32 h-32 mx-auto rounded-full border border-gold-500/30 bg-black/40 flex items-center justify-center relative mb-4">
                    <i class="fas fa-fire text-5xl text-gold-500"></i>
                    <div class="absolute inset-0 rounded-full border-2 border-dashed border-gold-500/20 animate-spin-slow"></div>
                </div>
                <h1 class="text-5xl font-serif font-bold text-white tracking-widest">ASHES</h1>
                <p class="text-gray-400 text-[10px] tracking-[0.3em] uppercase mt-2">Ramadan Legacy Tracker</p>
            </div>
            <div class="space-y-4">
                <input type="text" id="usernameInput" placeholder="Enter Your Name" class="w-full bg-ashes-900 border border-gray-700 rounded-xl px-5 py-4 text-white focus:border-gold-500 outline-none text-center">
                <button onclick="app.login()" class="w-full bg-gradient-to-r from-gold-600 to-gold-500 hover:to-gold-400 text-black font-bold py-4 rounded-xl shadow-lg transition-all">ENTER PORTAL</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="appScreen" class="relative z-10 hidden pb-24">
        
        <header class="bg-ashes-950/80 backdrop-blur-xl border-b border-gray-800/50 sticky top-0 z-40 shadow-lg">
            <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-ashes-800 rounded-full flex items-center justify-center border border-gold-600/30"><i class="fas fa-fire text-gold-500 text-sm"></i></div>
                    <div>
                        <h2 class="font-bold text-white leading-none tracking-widest font-serif">ASHES</h2>
                        <p class="text-[9px] text-gold-500 uppercase tracking-widest" id="userDisplay">MEMBER</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="app.scrollToSection('leaderboardSection')" class="text-gray-400 hover:text-gold-400 bg-ashes-800/50 p-2.5 rounded-lg"><i class="fas fa-trophy"></i></button>
                    <button onclick="app.logout()" class="text-gray-400 hover:text-red-400 bg-ashes-800/50 p-2.5 rounded-lg"><i class="fas fa-power-off"></i></button>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto px-4 py-6 space-y-6">
            
            <!-- Tools -->
            <div class="grid grid-cols-2 gap-3">
                <button onclick="app.openTasbih()" class="glass-panel p-4 rounded-xl flex items-center justify-between group hover:bg-ashes-800/50 transition-all cursor-pointer">
                    <div class="text-left"><p class="text-[10px] text-gray-500 uppercase font-bold">Tool</p><h4 class="text-white font-serif font-bold">Tasbih</h4></div>
                    <i class="fas fa-fingerprint text-gold-500 text-2xl group-hover:scale-110 transition-transform"></i>
                </button>
                <button onclick="app.openDuas()" class="glass-panel p-4 rounded-xl flex items-center justify-between group hover:bg-ashes-800/50 transition-all cursor-pointer">
                    <div class="text-left"><p class="text-[10px] text-gray-500 uppercase font-bold">Library</p><h4 class="text-white font-serif font-bold">Duas</h4></div>
                    <i class="fas fa-praying-hands text-emerald-400 text-2xl group-hover:scale-110 transition-transform"></i>
                </button>
            </div>

            <!-- Verse -->
            <div class="glass-panel p-6 rounded-2xl text-center border-t border-gold-600/50 relative overflow-hidden">
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-gold-600/10 rounded-full blur-3xl"></div>
                <span class="inline-block px-3 py-1 rounded-full bg-gold-900/30 border border-gold-600/30 text-[10px] text-gold-400 uppercase tracking-wider mb-3">Daily Verse</span>
                <p class="font-arabic text-2xl text-white mb-2" id="dailyArabic">Loading...</p>
                <p class="text-gray-400 text-sm italic" id="dailyEnglish">Loading...</p>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="glass-panel p-4 rounded-xl text-center"><p class="text-2xl font-bold text-white" id="statFasts">0</p><p class="text-[10px] text-gray-500 uppercase">Fasts</p></div>
                <div class="glass-panel p-4 rounded-xl text-center"><p class="text-2xl font-bold text-emerald-400" id="statSalah">0%</p><p class="text-[10px] text-gray-500 uppercase">Salah</p></div>
                <div class="glass-panel p-4 rounded-xl text-center"><p class="text-2xl font-bold text-orange-400" id="statStreak">0</p><p class="text-[10px] text-gray-500 uppercase">Streak</p></div>
                <div class="glass-panel p-4 rounded-xl text-center"><p class="text-2xl font-bold text-gold-500" id="statPoints">0</p><p class="text-[10px] text-gray-500 uppercase">Score</p></div>
            </div>

            <button onclick="app.openLogger()" class="w-full bg-gradient-to-r from-ashes-800 to-ashes-900 border border-gold-600/30 hover:border-gold-500 p-6 rounded-2xl flex items-center justify-between group transition-all shadow-lg">
                <div class="text-left"><h3 class="text-xl font-serif font-bold text-white">Log Progress</h3><p class="text-sm text-gray-400">Record Salah, Fasting, Quran</p></div>
                <div class="w-12 h-12 bg-gold-600 rounded-full flex items-center justify-center text-black shadow-lg group-hover:scale-110 transition-transform"><i class="fas fa-plus text-xl"></i></div>
            </button>

            <!-- Khatam -->
            <div class="glass-panel p-6 rounded-2xl border border-gray-800 relative overflow-hidden">
                <div class="flex justify-between items-end mb-4">
                    <div><h3 class="text-gold-500 font-bold text-lg"><i class="fas fa-book-open mr-2"></i> Khatam Tracker</h3><p class="text-xs text-gray-400">Goal: 604 Pages</p></div>
                    <div class="text-right"><div class="text-2xl font-bold text-white"><span id="khatamCurrentDisplay">0</span><span class="text-gray-600 text-lg">/604</span></div><div class="text-[10px] text-emerald-500 font-bold uppercase" id="khatamPercent">0%</div></div>
                </div>
                <div class="relative h-3 bg-black/50 rounded-full overflow-hidden mb-6 border border-gray-700/50"><div id="khatamBar" class="absolute top-0 left-0 h-full bg-emerald-500 transition-all duration-1000" style="width: 0%"></div></div>
                <div class="flex items-center gap-4 bg-ashes-900/50 p-3 rounded-xl border border-gray-800">
                    <span class="text-[10px] text-gray-500 font-bold uppercase">Pg 1</span>
                    <input type="range" min="0" max="604" value="0" id="khatamSlider" class="w-full" oninput="app.updateKhatamVisuals()">
                    <span class="text-[10px] text-gray-500 font-bold uppercase">Pg 604</span>
                </div>
                <div class="flex justify-end mt-3"><button onclick="app.saveKhatam()" class="text-xs bg-ashes-800 hover:bg-gold-600 hover:text-black text-gold-500 border border-gold-600/30 px-4 py-2 rounded-lg transition-all font-bold">Update</button></div>
            </div>

            <!-- Leaderboard -->
            <div id="leaderboardSection" class="glass-panel p-6 rounded-2xl border border-gold-600/20">
                <div class="flex justify-between items-center mb-6">
                    <div><h3 class="text-white font-bold text-lg uppercase tracking-wider font-serif">Team Standings</h3><p class="text-xs text-gray-400">Live Rankings</p></div>
                    <div class="bg-ashes-900/80 px-3 py-1.5 rounded-lg border border-gold-600/20"><span class="text-xs text-gold-500 font-bold"><i class="fas fa-crown mr-1"></i> Leaderboard</span></div>
                </div>
                <div class="overflow-hidden rounded-xl border border-gray-800">
                    <table class="w-full text-left text-sm"><thead class="bg-ashes-900 text-gray-500 uppercase text-[10px] font-bold"><tr><th class="px-4 py-3">Rank</th><th class="px-4 py-3">Member</th><th class="px-4 py-3 text-center">Fasts</th><th class="px-4 py-3 text-right">Score</th></tr></thead>
                    <tbody id="leaderboardBody" class="divide-y divide-gray-800 bg-ashes-900/40"></tbody></table>
                </div>
            </div>

            <!-- History -->
            <div><div class="flex justify-between items-end mb-4 px-1"><h3 class="text-gold-500/70 text-xs font-bold uppercase tracking-wider">History</h3></div><div id="logsContainer" class="space-y-3"></div></div>
        </main>
    </div>

    <!-- Modals -->
    <div id="tasbihModal" class="fixed inset-0 z-50 hidden"><div class="absolute inset-0 bg-black/95 backdrop-blur-md" onclick="app.closeTasbih()"></div><div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-sm glass-panel p-8 rounded-3xl border border-gold-600/30 text-center"><h3 class="text-gold-500 font-serif text-2xl font-bold mb-1">Tasbih</h3><div class="bg-black/40 rounded-full w-48 h-48 mx-auto flex items-center justify-center border-4 border-gray-800 mb-6"><span id="tasbihCount" class="text-6xl font-mono font-bold text-white">0</span></div><button onclick="app.tasbihClick()" class="w-full bg-emerald-600 text-white font-bold py-4 rounded-xl shadow-lg mb-3 text-lg">COUNT</button><button onclick="app.tasbihReset()" class="text-xs text-gray-500">RESET</button></div></div>

    <div id="duasModal" class="fixed inset-0 z-50 hidden"><div class="absolute inset-0 bg-black/95 backdrop-blur-md" onclick="app.closeDuas()"></div><div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md h-[80vh] glass-panel rounded-3xl border border-gray-800 flex flex-col"><div class="p-5 border-b border-gray-800 flex justify-between items-center"><h3 class="text-white font-serif text-xl font-bold">Duas</h3><button onclick="app.closeDuas()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button></div><div class="p-6 overflow-y-auto space-y-6 flex-1"><div class="bg-ashes-900/50 p-4 rounded-xl border border-gray-700/50"><p class="text-[10px] text-gold-500 uppercase font-bold mb-2">Iftar</p><p class="font-arabic text-xl text-right mb-2">Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ù„ÙÙƒÙ ØµÙÙ…Ù’ØªÙ ÙˆÙØ¹ÙÙ„ÙÙ‰ Ø±ÙØ²Ù’Ù‚ÙÙƒÙ Ø£ÙÙÙ’Ø·ÙØ±Ù’ØªÙ</p></div><div class="bg-ashes-900/50 p-4 rounded-xl border border-gray-700/50"><p class="text-[10px] text-gold-500 uppercase font-bold mb-2">Suhoor</p><p class="font-arabic text-xl text-right mb-2">ÙˆÙØ¨ÙØµÙÙˆÙ’Ù…Ù ØºÙØ¯Ù Ù†ÙÙ‘ÙˆÙÙŠÙ’ØªÙ Ù…ÙÙ†Ù’ Ø´ÙÙ‡Ù’Ø±Ù Ø±ÙÙ…ÙØ¶ÙØ§Ù†Ù</p></div></div></div></div>

    <div id="logModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-md" onclick="app.closeLogger()"></div>
        <div class="absolute bottom-0 md:top-1/2 md:left-1/2 md:transform md:-translate-x-1/2 md:-translate-y-1/2 md:bottom-auto w-full md:w-[500px] md:rounded-2xl bg-[#0f0f0f] border border-gray-800 shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-5 border-b border-gray-800 flex justify-between items-center bg-ashes-900/50 rounded-t-2xl"><div><h3 class="font-serif text-xl font-bold text-gold-500">Log Day</h3></div><button onclick="app.closeLogger()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button></div>
            <div class="overflow-y-auto p-6 space-y-6 flex-1 custom-scrollbar">
                <div><label class="block text-gray-500 text-[10px] uppercase font-bold mb-2">Date</label><input type="date" id="logDate" class="w-full bg-ashes-900 border border-gray-800 rounded-xl p-4 text-white outline-none"></div>
                <div class="space-y-4">
                    <h4 class="text-white font-bold text-sm border-b border-gray-800 pb-2">Obligations</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-ashes-800/30 rounded-xl border border-gray-700/30 flex items-center justify-between"><span class="text-gray-300 text-sm font-bold">Fasting?</span><input type="checkbox" id="checkFast" class="w-5 h-5 accent-gold-500"></div>
                        <div class="p-4 bg-ashes-800/30 rounded-xl border border-gray-700/30 flex items-center justify-between"><span class="text-gray-300 text-sm font-bold">Charity?</span><input type="checkbox" id="checkSadaqah" class="w-5 h-5 accent-emerald-500"></div>
                    </div>
                    <div><label class="block text-gray-500 text-[10px] uppercase font-bold mb-3 text-center">Prayers</label><div class="grid grid-cols-5 gap-2"><label class="cursor-pointer"><input type="checkbox" class="peer sr-only prayer-check" value="Fajr"><div class="h-10 w-full rounded bg-ashes-800 border border-gray-700 flex items-center justify-center text-gray-500 peer-checked:bg-emerald-900/30 peer-checked:text-emerald-400 text-[9px] font-bold">Fajr</div></label><label class="cursor-pointer"><input type="checkbox" class="peer sr-only prayer-check" value="Dhuhr"><div class="h-10 w-full rounded bg-ashes-800 border border-gray-700 flex items-center justify-center text-gray-500 peer-checked:bg-emerald-900/30 peer-checked:text-emerald-400 text-[9px] font-bold">Dhuhr</div></label><label class="cursor-pointer"><input type="checkbox" class="peer sr-only prayer-check" value="Asr"><div class="h-10 w-full rounded bg-ashes-800 border border-gray-700 flex items-center justify-center text-gray-500 peer-checked:bg-emerald-900/30 peer-checked:text-emerald-400 text-[9px] font-bold">Asr</div></label><label class="cursor-pointer"><input type="checkbox" class="peer sr-only prayer-check" value="Maghrib"><div class="h-10 w-full rounded bg-ashes-800 border border-gray-700 flex items-center justify-center text-gray-500 peer-checked:bg-emerald-900/30 peer-checked:text-emerald-400 text-[9px] font-bold">Mag</div></label><label class="cursor-pointer"><input type="checkbox" class="peer sr-only prayer-check" value="Isha"><div class="h-10 w-full rounded bg-ashes-800 border border-gray-700 flex items-center justify-center text-gray-500 peer-checked:bg-emerald-900/30 peer-checked:text-emerald-400 text-[9px] font-bold">Isha</div></label></div></div>
                </div>
                <div class="space-y-4">
                    <h4 class="text-white font-bold text-sm border-b border-gray-800 pb-2">Quran</h4>
                    <div class="flex items-center gap-2 mb-4 bg-ashes-900 p-2 rounded-xl border border-gray-800"><span class="text-gray-300 text-sm flex-1 pl-2">Read Quran?</span><div class="flex gap-2"><button onclick="app.toggleQuran(true)" id="btnQuranYes" class="px-5 py-2 rounded-lg text-xs font-bold bg-ashes-800 border border-gray-700 text-gray-400">Yes</button><button onclick="app.toggleQuran(false)" id="btnQuranNo" class="px-5 py-2 rounded-lg text-xs font-bold bg-ashes-800 border border-gray-700 text-gray-400">No</button></div></div>
                    <div id="quranDetails" class="hidden space-y-4 bg-ashes-800/20 p-5 rounded-xl border border-gold-600/20">
                        <div><label class="block text-gray-500 text-[10px] uppercase font-bold mb-2">Surah</label><select id="surahSelect" class="w-full bg-ashes-900 border border-gray-700 rounded-xl p-3 text-white text-sm outline-none"></select><div id="customSurahContainer" class="hidden mt-2"><input type="text" id="customSurahInput" placeholder="Type Name..." class="w-full bg-ashes-900 border border-gold-600/50 rounded-xl p-3 text-white text-sm outline-none"></div></div>
                        <div class="grid grid-cols-2 gap-3"><div><label class="block text-gray-500 text-[10px] uppercase font-bold mb-2">Pages</label><input type="number" id="versesCount" class="w-full bg-ashes-900 border border-gray-700 rounded-xl p-3 text-white text-sm outline-none"></div><div><label class="block text-gray-500 text-[10px] uppercase font-bold mb-2">Time</label><select id="readTime" class="w-full bg-ashes-900 border border-gray-700 rounded-xl p-3 text-white text-sm outline-none"><option value="Fajr">Fajr</option><option value="Noon">Noon</option><option value="Taraweeh">Taraweeh</option></select></div></div>
                        <div class="bg-gradient-to-br from-ashes-950 to-black p-4 rounded-xl border border-gold-900/30"><label class="flex items-center cursor-pointer"><input type="checkbox" id="checkTranslation" class="w-4 h-4 accent-gold-500" onchange="app.toggleTranslation()"><span class="ml-2 text-sm text-gold-400 font-bold">Read Translation</span></label><div id="verificationSection" class="hidden mt-3 pt-3 border-t border-gray-800"><label class="block text-xs text-emerald-400 mb-2 font-bold">Reflection</label><textarea id="reflectionInput" rows="2" class="w-full bg-ashes-900/50 border border-gray-700 rounded-lg p-3 text-sm text-white outline-none"></textarea><p class="text-[9px] text-gray-500 mt-1 text-right" id="charCount">0/10</p></div></div>
                    </div>
                </div>
            </div>
            <div class="p-5 border-t border-gray-800 bg-ashes-900/80 rounded-b-2xl"><button onclick="app.submitLog()" class="w-full bg-gradient-to-r from-gold-600 to-gold-500 text-black font-bold py-4 rounded-xl shadow-lg">SAVE RECORD</button></div>
        </div>
    </div>

    <div id="toast" class="fixed top-5 right-5 z-50 transform translate-x-full transition-transform duration-300"><div class="bg-ashes-800 border-l-4 border-gold-500 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center border border-gray-700/50"><i class="fas fa-check-circle text-gold-500 mr-3 text-xl"></i><div><h4 class="font-bold text-sm text-white">Success</h4><p class="text-xs text-gray-400" id="toastMsg">Action completed</p></div></div></div>

    <!-- Error Modal for Permissions -->
    <div id="errorModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-sm"></div>
        <div class="relative bg-ashes-900 border border-red-500/50 rounded-2xl p-6 max-w-md w-full shadow-2xl">
            <div class="flex items-center gap-3 text-red-500 mb-4">
                <i class="fas fa-lock text-2xl"></i>
                <h3 class="font-bold text-lg">Database Locked</h3>
            </div>
            <p class="text-gray-300 text-sm mb-4">The app cannot save data because the database rules are too strict.</p>
            <div class="bg-black/50 p-4 rounded-lg border border-gray-800 mb-4">
                <p class="text-xs text-gray-500 uppercase font-bold mb-2">How to Fix (Required):</p>
                <ol class="list-decimal list-inside text-xs text-gray-400 space-y-2">
                    <li>Go to Firebase Console > Build > <strong>Firestore Database</strong>.</li>
                    <li>Click the <strong>Rules</strong> tab.</li>
                    <li>Replace the code with this (allows anyone to read/write):
                        <pre class="mt-2 bg-gray-900 p-2 rounded border border-gray-700 overflow-x-auto"><code>allow read, write: if true;</code></pre>
                    </li>
                    <li>Click <strong>Publish</strong>.</li>
                </ol>
            </div>
            <button onclick="document.getElementById('errorModal').classList.add('hidden')" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl transition-colors">I Fixed It</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCF04TLqqjLz1olCsjaA3PdATwqbyd5aNw",
            authDomain: "ashes-trac.firebaseapp.com",
            projectId: "ashes-trac",
            storageBucket: "ashes-trac.firebasestorage.app",
            messagingSenderId: "1038049260529",
            appId: "1:1038049260529:web:401583810f6042562e8a50"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const teamGroupId = 'team-ashes-2025';

        window.app = {
            state: {
                user: null, 
                logs: [],
                leaderboard: [],
                khatamPage: 0,
                quranActive: false,
                tasbihCount: 0
            },

            init: async function() {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Auth Failed", error);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        this.state.user = user;
                        this.setupRealtimeListeners(user.uid);
                    }
                });

                this.setupUI();
            },

            setupRealtimeListeners: function(userId) {
                // My Logs
                const logsRef = collection(db, 'artifacts', teamGroupId, 'users', userId, 'logs');
                onSnapshot(logsRef, (snapshot) => {
                    this.state.logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.state.logs.sort((a, b) => new Date(b.date) - new Date(a.date));
                    this.renderDashboard();
                    this.renderLogs();
                }, (err) => {
                    if(err.code === 'permission-denied') document.getElementById('errorModal').classList.remove('hidden');
                });

                // Leaderboard
                const lbRef = collection(db, 'artifacts', teamGroupId, 'public', 'data', 'leaderboard');
                onSnapshot(lbRef, (snapshot) => {
                    this.state.leaderboard = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
                    
                    const myProfile = this.state.leaderboard.find(p => p.uid === userId);
                    if (myProfile) {
                        this.state.khatamPage = myProfile.khatamPage || 0;
                        document.getElementById('authScreen').classList.add('hidden');
                        document.getElementById('appScreen').classList.remove('hidden');
                        document.getElementById('appScreen').classList.add('fade-in');
                        document.getElementById('userDisplay').innerText = myProfile.name;
                        this.updateKhatamVisuals();
                    } else {
                        document.getElementById('authScreen').classList.remove('hidden');
                        document.getElementById('appScreen').classList.add('hidden');
                    }
                    this.renderLeaderboard();
                }, (err) => {
                     if(err.code === 'permission-denied') document.getElementById('errorModal').classList.remove('hidden');
                });
            },

            login: async function() {
                try {
                    const name = document.getElementById('usernameInput').value.trim();
                    if (!name) return alert("Please enter your name");
                    if (!this.state.user) return alert("Connecting... please wait.");

                    const userRef = doc(db, 'artifacts', teamGroupId, 'public', 'data', 'leaderboard', this.state.user.uid);
                    await setDoc(userRef, {
                        name: name,
                        score: 0,
                        fasts: 0,
                        khatamPage: 0,
                        joinedAt: new Date().toISOString()
                    }, { merge: true });
                } catch (error) {
                    if (error.code === 'permission-denied') document.getElementById('errorModal').classList.remove('hidden');
                    else alert(error.message);
                }
            },

            logout: function() {
                if(confirm("Log out?")) {
                    auth.signOut();
                    location.reload();
                }
            },

            submitLog: async function() {
                try {
                    if (!this.state.user) return;
                    const date = document.getElementById('logDate').value;
                    if(!date) return alert("Select date");

                    const existing = this.state.logs.find(l => l.date === date);
                    if(existing) {
                        if(!confirm("Overwrite existing log for this date?")) return;
                        await deleteDoc(doc(db, 'artifacts', teamGroupId, 'users', this.state.user.uid, 'logs', existing.id));
                    }

                    const fasted = document.getElementById('checkFast').checked;
                    const sadaqah = document.getElementById('checkSadaqah').checked;
                    const prayers = [];
                    document.querySelectorAll('.prayer-check:checked').forEach(cb => prayers.push(cb.value));

                    let quranData = null;
                    if (this.state.quranActive) {
                        let surah = document.getElementById('surahSelect').value;
                        if(surah === 'Other') surah = document.getElementById('customSurahInput').value.trim();
                        const verses = document.getElementById('versesCount').value;
                        const time = document.getElementById('readTime').value;
                        const translation = document.getElementById('checkTranslation').checked;
                        const reflection = document.getElementById('reflectionInput').value.trim();
                        
                        if (!surah && (!verses || verses == 0)) return alert("Please specify Surah or Pages.");
                        quranData = { surah, verses, time, translation, reflection };
                    }

                    await addDoc(collection(db, 'artifacts', teamGroupId, 'users', this.state.user.uid, 'logs'), {
                        date, fasted, sadaqah, prayers, quran: quranData, timestamp: new Date().toISOString()
                    });

                    const tempLogs = [...this.state.logs.filter(l => l.date !== date), { fasted, sadaqah, prayers, quran: quranData }];
                    await this.updateProfile(tempLogs, this.state.khatamPage);

                    this.closeLogger();
                    this.showToast("Saved!");
                } catch (error) {
                    if (error.code === 'permission-denied') document.getElementById('errorModal').classList.remove('hidden');
                    else alert(error.message);
                }
            },

            deleteLog: async function(id) {
                try {
                    if(!confirm("Delete entry?")) return;
                    await deleteDoc(doc(db, 'artifacts', teamGroupId, 'users', this.state.user.uid, 'logs', id));
                    const tempLogs = this.state.logs.filter(l => l.id !== id);
                    await this.updateProfile(tempLogs, this.state.khatamPage);
                    this.showToast("Deleted");
                } catch (error) {
                    if (error.code === 'permission-denied') document.getElementById('errorModal').classList.remove('hidden');
                }
            },

            saveKhatam: async function() {
                try {
                    const val = document.getElementById('khatamSlider').value;
                    this.state.khatamPage = val;
                    await this.updateProfile(this.state.logs, val);
                    this.showToast("Khatam Updated");
                } catch (error) {
                    if (error.code === 'permission-denied') document.getElementById('errorModal').classList.remove('hidden');
                }
            },

            updateProfile: async function(logs, khatam) {
                let score = 0;
                let fasts = 0;
                logs.forEach(l => {
                    if (l.fasted) { score += 50; fasts++; }
                    if (l.prayers) score += (l.prayers.length * 10);
                    if (l.sadaqah) score += 20;
                    if (l.quran) { score += 20; if (l.quran.translation) score += 15; }
                });
                score += (parseInt(khatam || 0) * 2);

                const userRef = doc(db, 'artifacts', teamGroupId, 'public', 'data', 'leaderboard', this.state.user.uid);
                await setDoc(userRef, { score, fasts, khatamPage: parseInt(khatam) }, { merge: true });
            },

            calculateStreak: function(logs) {
                if(!logs.length) return 0;
                const uniqueDates = [...new Set(logs.map(l=>l.date))].sort((a,b)=>new Date(b)-new Date(a));
                const today = new Date().toISOString().split('T')[0];
                const yest = new Date(Date.now()-86400000).toISOString().split('T')[0];
                if(uniqueDates[0] !== today && uniqueDates[0] !== yest) return 0;
                let streak = 1;
                for(let i=0; i<uniqueDates.length-1; i++) {
                    const diff = (new Date(uniqueDates[i]) - new Date(uniqueDates[i+1])) / (1000*60*60*24);
                    if(Math.ceil(diff) === 1) streak++; else break;
                }
                return streak;
            },

            calculateTotalScore: function(logs, khatamPage) {
                let score = 0;
                logs.forEach(l => {
                    if (l.fasted) score += 50;
                    if (l.prayers) score += (l.prayers.length * 10);
                    if (l.sadaqah) score += 20;
                    if (l.quran) { score += 20; if (l.quran.translation) score += 15; }
                });
                score += (parseInt(khatamPage || 0) * 2);
                return score;
            },

            setupUI: function() {
                const surahList = ["Al-Fatiha", "Al-Baqarah", "Al-Imran", "An-Nisa", "Al-Ma'idah", "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Tawbah", "Yunus", "Hud", "Yusuf", "Ar-Ra'd", "Ibrahim", "Al-Hijr", "An-Nahl", "Al-Isra", "Al-Kahf", "Maryam", "Ta-Ha", "Al-Anbiya", "Al-Hajj", "Al-Mu'minun", "An-Nur", "Al-Furqan", "Ash-Shu'ara", "An-Naml", "Al-Qasas", "Al-Ankabut", "Ar-Rum", "Luqman", "As-Sajdah", "Al-Ahzab", "Saba", "Fatir", "Ya-Sin", "As-Saffat", "Sad", "Az-Zumar", "Ghafir", "Fussilat", "Ash-Shura", "Az-Zukhruf", "Ad-Dukhan", "Al-Jathiyah", "Al-Ahqaf", "Muhammad", "Al-Fath", "Al-Hujurat", "Qaf", "Adh-Dhariyat", "At-Tur", "An-Najm", "Al-Qamar", "Ar-Rahman", "Al-Waqi'ah", "Al-Hadid", "Al-Mujadila", "Al-Hashr", "Al-Mumtahanah", "As-Saff", "Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "At-Talaq", "At-Tahrim", "Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij", "Nuh", "Al-Jinn", "Al-Muzzammil", "Al-Muddaththir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat", "An-Naba", "An-Nazi'at", "Abasa", "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Inshiqaq", "Al-Buruj", "At-Tariq", "Al-A'la", "Al-Ghashiyah", "Al-Fajr", "Al-Balad", "Ash-Shams", "Al-Layl", "Ad-Duhaa", "Ash-Sharh", "At-Tin", "Al-Alaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-Adiyat", "Al-Qari'ah", "At-Takathur", "Al-Asr", "Al-Humazah", "Al-Fil", "Quraysh", "Al-Ma'un", "Al-Kawthar", "Al-Kafirun", "An-Nasr", "Al-Masad", "Al-Ikhlas", "Al-Falaq", "An-Nas"];
                const s = document.getElementById('surahSelect');
                if(!s) return; 
                s.innerHTML = '<option value="">Select Surah...</option>';
                surahList.forEach((n,i)=> s.innerHTML += `<option value="${n}">${i+1}. ${n}</option>`);
                s.innerHTML += '<option value="Other">Other / Type Name</option>';

                const logDate = document.getElementById('logDate');
                if(logDate) logDate.value = new Date().toISOString().split('T')[0];
                
                const vs = [ { ar: "ÙÙØ¥ÙÙ†ÙÙ‘ Ù…ÙØ¹Ù Ù±Ù„Ù’Ø¹ÙØ³Ù’Ø±Ù ÙŠÙØ³Ù’Ø±Ù‹Ø§", en: "For indeed, with hardship [will be] ease." }, { ar: "Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù†ÙÙˆØ±Ù Ù±Ù„Ø³ÙÙ‘Ù…ÙÙ°ÙˆÙÙ°ØªÙ ÙˆÙÙ±Ù„Ù’Ø£ÙØ±Ù’Ø¶Ù", en: "Allah is the Light of the heavens and the earth." } ];
                const r = vs[Math.floor(Math.random()*vs.length)];
                
                const dailyAr = document.getElementById('dailyArabic');
                if(dailyAr) dailyAr.innerText = r.ar;
                
                const dailyEn = document.getElementById('dailyEnglish');
                if(dailyEn) dailyEn.innerText = r.en;

                s.addEventListener('change', (e) => {
                    const customContainer = document.getElementById('customSurahContainer');
                    if(customContainer) customContainer.classList.toggle('hidden', e.target.value !== 'Other');
                });
            },

            updateKhatamVisuals: function() {
                const val = this.state.khatamPage;
                const disp = document.getElementById('khatamCurrentDisplay');
                if(disp) disp.innerText = val;
                
                const slider = document.getElementById('khatamSlider');
                if(slider) slider.value = val;
                
                const p = Math.round((val/604)*100);
                const perc = document.getElementById('khatamPercent');
                if(perc) perc.innerText = `${p}% Completed`;
                
                const bar = document.getElementById('khatamBar');
                if(bar) bar.style.width = `${p}%`;
            },

            renderDashboard: function() {
                const fasts = this.state.logs.filter(l => l.fasted).length;
                let prayers = 0;
                this.state.logs.forEach(l => prayers += (l.prayers ? l.prayers.length : 0));
                const tp = this.state.logs.length * 5;
                const sp = tp > 0 ? Math.round((prayers/tp)*100) : 0;
                const streak = this.calculateStreak(this.state.logs);
                const myProfile = this.state.leaderboard.find(p => p.uid === this.state.user?.uid);
                const score = myProfile ? myProfile.score : 0;

                const elFasts = document.getElementById('statFasts');
                if(elFasts) elFasts.innerText = fasts;
                
                const elSalah = document.getElementById('statSalah');
                if(elSalah) elSalah.innerText = `${sp}%`;
                
                const elStreak = document.getElementById('statStreak');
                if(elStreak) elStreak.innerText = streak;
                
                const elPoints = document.getElementById('statPoints');
                if(elPoints) elPoints.innerText = score.toLocaleString();
            },

            renderLeaderboard: function() {
                const b = document.getElementById('leaderboardBody');
                if(!b) return;
                b.innerHTML = '';
                const d = [...this.state.leaderboard].sort((a,b) => b.score - a.score);
                
                d.forEach((u, i) => {
                    const isMe = this.state.user && u.uid === this.state.user.uid;
                    const rank = i+1;
                    let c = 'text-gray-500';
                    if(rank===1) c='text-gold-400 font-bold';
                    if(rank===2) c='text-gray-300 font-bold';
                    if(rank===3) c='text-orange-400 font-bold';
                    const rowClass = isMe ? 'bg-gold-900/10 border-l-2 border-gold-500 border-b border-gray-800/50' : 'border-b border-gray-800/50 hover:bg-ashes-800/30';
                    
                    b.innerHTML += `
                    <tr class="${rowClass} transition-colors">
                        <td class="px-4 py-3 font-mono ${c}">#${rank}</td>
                        <td class="px-4 py-3 text-white font-medium flex items-center">
                            ${u.name} ${rank===1 ? '<i class="fas fa-crown text-gold-500 ml-2 text-xs"></i>' : ''}
                            ${isMe ? '<span class="ml-2 px-1.5 py-0.5 rounded border border-gold-600/30 bg-gold-600/20 text-gold-400 text-[9px] font-bold">YOU</span>' : ''}
                        </td>
                        <td class="px-4 py-3 text-center text-gray-400 text-xs font-mono">${u.fasts || 0}</td>
                        <td class="px-4 py-3 text-right font-mono text-gold-500 font-bold">${(u.score||0).toLocaleString()}</td>
                    </tr>`;
                });
            },

            renderLogs: function() {
                const c = document.getElementById('logsContainer');
                if(!c) return;
                c.innerHTML = '';
                if(this.state.logs.length === 0) {
                    c.innerHTML = `<div class="glass-panel p-8 rounded-xl text-center border-dashed border border-gray-800 opacity-60"><i class="fas fa-scroll text-3xl mb-2"></i><p class="text-xs">No logs yet.</p></div>`;
                    return;
                }
                
                this.state.logs.forEach(l => {
                    const d = new Date(l.date);
                    const day = d.getDate();
                    const month = d.toLocaleString('default', {month:'short'});
                    const badges = `
                        ${l.fasted ? '<span class="text-[9px] font-bold bg-emerald-900/30 text-emerald-400 px-2 py-0.5 rounded border border-emerald-900/50">FASTED</span>' : ''}
                        ${l.sadaqah ? '<span class="text-[9px] font-bold bg-gold-900/20 text-gold-400 px-2 py-0.5 rounded border border-gold-600/20"><i class="fas fa-hand-holding-heart"></i></span>' : ''}
                        ${l.quran ? '<span class="text-[9px] font-bold bg-blue-900/20 text-blue-400 px-2 py-0.5 rounded border border-blue-600/20"><i class="fas fa-quran"></i></span>' : ''}
                    `;
                    c.innerHTML += `
                    <div class="glass-panel p-3 rounded-xl border-l-2 ${l.fasted?'border-l-gold-500':'border-l-gray-700'} flex justify-between items-center group hover:bg-ashes-800/40 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="bg-ashes-900/80 w-10 h-10 rounded-lg flex flex-col items-center justify-center border border-gray-800"><span class="text-[8px] text-gray-500 uppercase font-bold">${month}</span><span class="text-sm font-bold text-white leading-none">${day}</span></div>
                            <div>
                                <div class="flex gap-1 mb-1">${badges}</div>
                                <div class="text-emerald-400 text-[10px] font-bold"><i class="fas fa-pray"></i> ${l.prayers ? l.prayers.length : 0}/5</div>
                            </div>
                        </div>
                        <button onclick="app.deleteLog('${l.id}')" class="text-gray-600 hover:text-red-500 p-2 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fas fa-trash"></i></button>
                    </div>`;
                });
            },

            openLogger: function() {
                document.getElementById('logModal').classList.remove('hidden');
                document.getElementById('checkFast').checked = false;
                document.getElementById('checkSadaqah').checked = false;
                document.querySelectorAll('.prayer-check').forEach(c => c.checked = false);
                this.toggleQuran(false);
                document.getElementById('checkTranslation').checked = false;
                this.toggleTranslation();
                document.getElementById('versesCount').value = '';
                document.getElementById('reflectionInput').value = '';
                document.getElementById('surahSelect').value = '';
            },
            closeLogger: function() { document.getElementById('logModal').classList.add('hidden'); },
            toggleQuran: function(active) {
                this.state.quranActive = active;
                document.getElementById('quranDetails').classList.toggle('hidden', !active);
                document.getElementById('btnQuranYes').className = active ? "px-5 py-2 rounded-lg text-xs font-bold bg-gold-600 text-black shadow-lg" : "px-5 py-2 rounded-lg text-xs font-bold bg-ashes-800 border border-gray-700 text-gray-500";
                document.getElementById('btnQuranNo').className = !active ? "px-5 py-2 rounded-lg text-xs font-bold bg-gray-700 text-white shadow-lg" : "px-5 py-2 rounded-lg text-xs font-bold bg-ashes-800 border border-gray-700 text-gray-500";
            },
            toggleTranslation: function() {
                const c = document.getElementById('checkTranslation').checked;
                document.getElementById('verificationSection').classList.toggle('hidden', !c);
            },
            scrollToSection: function(id) { document.getElementById(id).scrollIntoView({behavior:'smooth'}); },
            showToast: function(msg) {
                const t = document.getElementById('toast');
                document.getElementById('toastMsg').innerText = msg;
                t.classList.remove('translate-x-full');
                setTimeout(() => t.classList.add('translate-x-full'), 3000);
            },
            openTasbih: function() { document.getElementById('tasbihModal').classList.remove('hidden'); this.state.tasbihCount=0; document.getElementById('tasbihCount').innerText=0; },
            closeTasbih: function() { document.getElementById('tasbihModal').classList.add('hidden'); },
            tasbihClick: function() { this.state.tasbihCount++; document.getElementById('tasbihCount').innerText=this.state.tasbihCount; if(navigator.vibrate) navigator.vibrate(20); },
            tasbihReset: function() { if(confirm("Reset?")) { this.state.tasbihCount=0; document.getElementById('tasbihCount').innerText=0; } },
            openDuas: function() { document.getElementById('duasModal').classList.remove('hidden'); },
            closeDuas: function() { document.getElementById('duasModal').classList.add('hidden'); }
        };

        document.addEventListener('DOMContentLoaded', () => window.app.init());
    </script>
</body>
</html>
