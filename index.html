<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ashes | Ramadan Tracker</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒ™</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Reem+Kufi:wght@400;500;700&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ashes: { 950: '#020202', 900: '#080808', 800: '#141414', 700: '#202020' }, 
                        gold: { 300: '#fcd34d', 400: '#fbbf24', 500: '#f59e0b', 600: '#d97706', 700: '#b45309' },
                        emerald: { 400: '#34d399', 500: '#10b981', 900: '#064e3b' }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'], serif: ['Amiri', 'serif'], arabic: ['Reem Kufi', 'sans-serif'] },
                    animation: { 'spin-slow': 'spin 20s linear infinite', 'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020202; color: #e5e7eb; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass-panel {
            background: rgba(18, 18, 18, 0.65);
            backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 8px 32px -4px rgba(0, 0, 0, 0.6);
        }
        .gold-glow { box-shadow: 0 0 40px rgba(217, 119, 6, 0.1); }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fbbf24, #b45309);
            cursor: pointer; margin-top: -10px;
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.4);
            border: 2px solid #141414;
            position: relative; z-index: 20;
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #262626; border-radius: 2px; }
        
        .fade-in { animation: fadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .divider-icon::before { content: "Û"; font-family: 'Amiri', serif; color: #d97706; font-size: 1.5rem; }
        .divider-line { height: 1px; flex-grow: 1; background: linear-gradient(90deg, transparent, #d97706 50%, transparent); opacity: 0.3; }
    </style>
</head>
<body class="min-h-screen relative overflow-x-hidden selection:bg-gold-500 selection:text-black">

    <div class="fixed inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-ashes-800 via-ashes-950 to-black pointer-events-none z-0"></div>
    <div class="fixed inset-0 islamic-pattern pointer-events-none z-0 opacity-10" style="background-image: radial-gradient(#d97706 1px, transparent 1px); background-size: 30px 30px;"></div>

    <!-- Auth Screen -->
    <div id="authScreen" class="relative z-10 flex flex-col items-center justify-center min-h-screen p-6">
        <div class="glass-panel p-10 rounded-[2rem] shadow-2xl max-w-sm w-full text-center border-t border-gold-500/10 gold-glow">
            <div class="mb-10 relative">
                <div class="w-32 h-32 mx-auto rounded-full border-2 border-gold-500/30 bg-black flex items-center justify-center relative mb-6 shadow-[0_0_40px_rgba(217,119,6,0.2)] overflow-hidden group">
                    <img src="1000160425.png" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700" alt="Ashes Logo">
                    <i class="fas fa-fire text-5xl text-gold-500 animate-pulse hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></i>
                    <div class="absolute inset-0 rounded-full border border-dashed border-gold-400/40 animate-spin-slow pointer-events-none"></div>
                </div>
                <h1 class="text-6xl font-serif font-bold text-gold-500 tracking-[0.2em] drop-shadow-lg" style="text-shadow: 0 2px 10px rgba(0,0,0,0.5);">ASHES</h1>
                <div class="flex items-center gap-2 justify-center mt-4 opacity-50">
                    <div class="h-px w-8 bg-gold-600"></div>
                    <span class="text-gold-600 text-xs">Û</span>
                    <div class="h-px w-8 bg-gold-600"></div>
                </div>
                <p class="text-gray-500 text-[10px] tracking-[0.4em] uppercase mt-2">Ramadan Legacy Tracker</p>
            </div>
            <div class="space-y-5">
                <div class="relative group">
                    <input type="text" id="usernameInput" placeholder="Enter Your Identity" class="w-full bg-ashes-900/60 border border-gray-800 rounded-xl px-5 py-4 text-white focus:border-gold-600/50 outline-none text-center transition-all placeholder-gray-700 font-serif tracking-wide">
                </div>
                <button id="loginBtn" onclick="app.login()" class="w-full bg-gradient-to-r from-gold-700 to-gold-500 hover:from-gold-600 hover:to-gold-400 text-black font-bold py-4 rounded-xl shadow-lg transition-all transform active:scale-[0.98] flex items-center justify-center gap-2 tracking-widest text-xs">
                    ENTER PORTAL
                </button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="appScreen" class="relative z-10 hidden pb-32">
        <header class="bg-ashes-950/80 backdrop-blur-xl border-b border-gray-800/50 sticky top-0 z-40 shadow-2xl">
            <div class="max-w-4xl mx-auto px-5 py-4 flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 bg-black rounded-full flex items-center justify-center border border-gold-600/30 shadow-inner overflow-hidden relative">
                        <img src="1000160425.png" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'" class="w-full h-full object-cover" alt="Ashes Logo">
                        <i class="fas fa-fire text-gold-500 text-sm hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2"></i>
                    </div>
                    <div>
                        <h2 class="font-bold text-white leading-none tracking-[0.2em] font-serif text-lg">ASHES</h2>
                        <p class="text-[9px] text-gold-600/80 uppercase tracking-widest mt-1 font-bold" id="userDisplay">MEMBER</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="btnLinkGoogle" onclick="app.linkGoogle()" class="hidden text-gray-500 hover:text-white bg-ashes-800/50 hover:bg-ashes-800 p-2.5 rounded-xl transition-all border border-transparent hover:border-blue-500/30"><i class="fab fa-google"></i></button>
                    <button onclick="app.scrollToSection('leaderboardSection')" class="text-gray-500 hover:text-gold-400 bg-ashes-800/50 hover:bg-ashes-800 p-2.5 rounded-xl transition-all border border-transparent hover:border-gold-600/10"><i class="fas fa-trophy"></i></button>
                    <button onclick="app.logout()" class="text-gray-500 hover:text-red-400 bg-ashes-800/50 hover:bg-ashes-800 p-2.5 rounded-xl transition-all border border-transparent hover:border-red-900/20"><i class="fas fa-power-off"></i></button>
                </div>
            </div>
        </header>

        <main class="max-w-4xl mx-auto px-4 py-8 space-y-8">
            <div class="text-center opacity-60 mb-2">
                <p class="font-arabic text-3xl text-gold-500/50">Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù°Ù‡Ù Ù±Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</p>
            </div>

            <div class="glass-panel p-8 rounded-[2rem] text-center border-t border-gold-600/20 relative overflow-hidden group">
                <div class="absolute -top-24 -left-24 w-64 h-64 bg-gold-600/5 rounded-full blur-3xl group-hover:bg-gold-600/10 transition-colors duration-1000"></div>
                <div class="relative z-10">
                    <div class="flex items-center justify-center gap-3 mb-4 opacity-50">
                        <div class="h-px w-8 bg-gold-600"></div>
                        <span class="text-[10px] text-gold-500 uppercase tracking-[0.3em]">Daily Verse</span>
                        <div class="h-px w-8 bg-gold-600"></div>
                    </div>
                    <p class="font-arabic text-3xl md:text-4xl text-white mb-4 leading-[2.2] drop-shadow-md" id="dailyArabic">Loading...</p>
                    <p class="text-gray-400 text-sm italic font-serif leading-relaxed px-4" id="dailyEnglish">Loading...</p>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                <div class="glass-panel p-5 rounded-2xl text-center hover:bg-ashes-800/40 transition-colors group"><p class="text-3xl font-bold text-white mb-1 group-hover:text-gold-400 transition-colors" id="statFasts">0</p><p class="text-[9px] text-gray-500 uppercase tracking-widest font-bold">Fasts</p></div>
                <div class="glass-panel p-5 rounded-2xl text-center hover:bg-ashes-800/40 transition-colors group"><p class="text-3xl font-bold text-emerald-500 mb-1" id="statSalah">0%</p><p class="text-[9px] text-gray-500 uppercase tracking-widest font-bold">Salah</p></div>
                <div class="glass-panel p-5 rounded-2xl text-center hover:bg-ashes-800/40 transition-colors"><p class="text-3xl font-bold text-orange-400 mb-1 flex justify-center items-center gap-1"><span id="statStreak">0</span><span class="text-base opacity-70">ğŸ”¥</span></p><p class="text-[9px] text-gray-500 uppercase tracking-widest font-bold">Streak</p></div>
                <div class="glass-panel p-5 rounded-2xl text-center hover:bg-ashes-800/40 transition-colors bg-gradient-to-b from-ashes-800/50 to-transparent"><p class="text-3xl font-bold text-gold-500 mb-1 font-mono" id="statPoints">0</p><p class="text-[9px] text-gray-500 uppercase tracking-widest font-bold">Score</p></div>
            </div>

            <button onclick="app.openLogger()" class="w-full bg-gradient-to-r from-ashes-800 to-ashes-900 border border-gold-600/20 hover:border-gold-500/50 p-6 rounded-[1.5rem] flex items-center justify-between group transition-all shadow-xl hover:shadow-gold-900/10 active:scale-[0.99]">
                <div class="text-left pl-2">
                    <h3 class="text-xl font-serif font-bold text-white group-hover:text-gold-400 transition-colors">Log Daily Progress</h3>
                    <p class="text-xs text-gray-500 mt-1 uppercase tracking-wider">Record Salah, Fasting, Quran</p>
                </div>
                <div class="w-14 h-14 bg-gradient-to-br from-gold-600 to-gold-800 rounded-full flex items-center justify-center text-black shadow-lg group-hover:scale-110 transition-transform relative z-10 group-hover:rotate-90 duration-300 border border-gold-400/20"><i class="fas fa-plus text-xl text-white"></i></div>
            </button>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="app.openTasbih()" class="glass-panel p-6 rounded-2xl flex flex-col items-center justify-center gap-3 group hover:bg-ashes-800/60 transition-all border border-transparent hover:border-gold-600/20"><i class="fas fa-fingerprint text-3xl text-gold-500 group-hover:scale-110 transition-transform"></i><p class="text-[10px] text-gray-400 uppercase font-bold tracking-widest">Tasbih</p></button>
                <button onclick="app.openDuas()" class="glass-panel p-6 rounded-2xl flex flex-col items-center justify-center gap-3 group hover:bg-ashes-800/60 transition-all border border-transparent hover:border-emerald-500/20"><i class="fas fa-praying-hands text-3xl text-emerald-500 group-hover:scale-110 transition-transform"></i><p class="text-[10px] text-gray-400 uppercase font-bold tracking-widest">Duas</p></button>
            </div>

            <!-- Khatam Tracker -->
            <div class="glass-panel p-8 rounded-[2rem] border border-gray-800 relative overflow-hidden">
                <div class="absolute right-0 top-0 opacity-5 transform translate-x-1/3 -translate-y-1/3 pointer-events-none"><i class="fas fa-quran text-9xl text-white"></i></div>
                <div class="flex justify-between items-end mb-6 relative z-10">
                    <div>
                        <h3 class="text-gold-500 font-bold text-lg flex items-center gap-2"><i class="fas fa-book-open text-xs"></i> Khatam Tracker</h3>
                        <p class="text-[10px] text-gray-500 mt-1 uppercase tracking-wider">Goal: 604 Pages</p>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-bold text-white font-mono leading-none"><span id="khatamCurrentDisplay">0</span><span class="text-gray-600 text-lg">/604</span></div>
                        <div class="text-[9px] text-emerald-500 font-bold uppercase tracking-wider mt-1" id="khatamPercent">0%</div>
                    </div>
                </div>
                <div class="relative h-3 bg-black/60 rounded-full overflow-hidden mb-8 border border-gray-700/50 shadow-inner">
                    <div id="khatamBar" class="absolute top-0 left-0 h-full bg-gradient-to-r from-emerald-900 via-emerald-600 to-emerald-400 transition-all duration-1000 shadow-[0_0_15px_rgba(16,185,129,0.3)]" style="width: 0%"></div>
                </div>

                <div class="flex items-center gap-3 bg-ashes-950/80 p-3 rounded-2xl border border-gray-800/50">
                    <button onclick="app.adjustKhatam(-1)" class="w-10 h-10 rounded-xl bg-ashes-800 hover:bg-ashes-700 text-gold-500 border border-gray-700 flex items-center justify-center transition-colors active:scale-95"><i class="fas fa-minus text-xs"></i></button>
                    <div class="flex-1 relative h-6 flex items-center">
                        <input type="range" min="0" max="604" value="0" id="khatamSlider" class="w-full h-full absolute inset-0 z-20 opacity-0 cursor-pointer" oninput="app.handleKhatamSlide(this.value)">
                        <div class="w-full h-1 bg-gray-800 rounded-full overflow-hidden relative z-10"><div id="khatamTrackFill" class="h-full bg-gold-600 w-0"></div></div>
                        <div id="khatamThumb" class="absolute h-5 w-5 bg-gold-500 rounded-full border-2 border-ashes-900 shadow-md z-10 pointer-events-none" style="left: 0%; transform: translateX(-50%)"></div>
                    </div>
                    <button onclick="app.adjustKhatam(1)" class="w-10 h-10 rounded-xl bg-ashes-800 hover:bg-ashes-700 text-gold-500 border border-gray-700 flex items-center justify-center transition-colors active:scale-95"><i class="fas fa-plus text-xs"></i></button>
                </div>
                
                <div class="flex justify-end mt-4">
                    <button onclick="app.saveKhatam()" class="text-[10px] bg-ashes-800 hover:bg-gold-600 hover:text-black text-gold-500 border border-gold-600/30 px-5 py-2 rounded-lg transition-all font-bold shadow-lg flex items-center gap-2 uppercase tracking-wide">
                        Update Progress <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>

            <div id="leaderboardSection" class="glass-panel p-6 rounded-[2rem] border border-gold-600/10">
                <div class="flex justify-between items-center mb-6 px-2">
                    <div><h3 class="text-white font-bold text-lg uppercase tracking-wider font-serif">Standings</h3></div>
                    <div class="bg-ashes-900/80 px-3 py-1.5 rounded-lg border border-gold-600/20 shadow-lg"><span class="text-[10px] text-gold-500 font-bold flex items-center gap-2 uppercase tracking-wide"><i class="fas fa-crown"></i> Team</span></div>
                </div>
                <div class="overflow-hidden rounded-2xl border border-gray-800/50 bg-ashes-900/30">
                    <table class="w-full text-left text-sm"><thead class="bg-ashes-950/80 text-gray-500 uppercase text-[9px] font-bold tracking-widest"><tr><th class="px-5 py-4">#</th><th class="px-5 py-4">Member</th><th class="px-5 py-4 text-center">Fasts</th><th class="px-5 py-4 text-right">Score</th></tr></thead><tbody id="leaderboardBody" class="divide-y divide-gray-800/50 text-xs"></tbody></table>
                </div>
            </div>

            <div>
                <div class="flex justify-between items-center mb-6 px-2"><div class="flex items-center gap-3 w-full"><div class="divider-line"></div><span class="divider-icon"></span><div class="divider-line"></div></div></div>
                <h3 class="text-center text-gold-500/50 text-[10px] font-bold uppercase tracking-[0.3em] mb-4">Your Journal</h3>
                <div id="logsContainer" class="space-y-3"></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Error Modal -->
    <div id="errorModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 fade-in">
        <div class="absolute inset-0 bg-black/90 backdrop-blur-md"></div>
        <div class="relative bg-ashes-900 border border-red-500/30 rounded-2xl p-8 max-w-md w-full shadow-2xl">
            <div class="flex flex-col items-center text-center gap-3 text-red-500 mb-4"><i class="fas fa-lock text-3xl mb-2"></i><h3 class="font-bold text-xl text-white">Database Locked</h3></div>
            <p class="text-gray-400 text-sm mb-6 text-center">The app cannot save data. You must update your Firebase Rules.</p>
            <button onclick="document.getElementById('errorModal').classList.add('hidden')" class="w-full bg-red-900/50 hover:bg-red-900 border border-red-500/50 text-red-200 font-bold py-3 rounded-xl transition-colors text-xs uppercase tracking-widest">Dismiss</button>
        </div>
    </div>

    <!-- Duas Modal (Correctly Placed) -->
    <div id="duasModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-md" onclick="app.closeDuas()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-md h-[80vh] glass-panel rounded-3xl border border-gray-800 flex flex-col animate-fadeIn">
            <div class="p-5 border-b border-gray-800 flex justify-between items-center bg-ashes-900/50">
                <h3 class="text-gold-500 font-serif text-2xl font-bold">Essential Duas</h3>
                <button onclick="app.closeDuas()" class="text-gray-500 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6 flex-1 custom-scrollbar">
                <div class="bg-ashes-900/50 p-4 rounded-xl border border-gray-700/50"><p class="text-[10px] text-gold-500 uppercase font-bold mb-2 tracking-widest">Moon Sighting (Hilal)</p><p class="font-arabic text-xl text-right mb-2 leading-loose">Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø£ÙÙ‡ÙÙ„ÙÙ‘Ù‡Ù Ø¹ÙÙ„ÙÙŠÙ’Ù†ÙØ§ Ø¨ÙØ§Ù„Ù’Ø£ÙÙ…Ù’Ù†Ù ÙˆÙØ§Ù„Ù’Ø¥ÙÙŠÙ…ÙØ§Ù†ÙØŒ ÙˆÙØ§Ù„Ø³ÙÙ‘Ù„ÙØ§Ù…ÙØ©Ù ÙˆÙØ§Ù„Ù’Ø¥ÙØ³Ù’Ù„ÙØ§Ù…ÙØŒ Ø±ÙØ¨ÙÙ‘ÙŠ ÙˆÙØ±ÙØ¨ÙÙ‘ÙƒÙ Ø§Ù„Ù„ÙÙ‘Ù‡Ù</p><p class="text-xs text-gray-400 italic">"O Allah, let this moon appear on us with security and faith; with safety and Islam. (O Moon!) My Lord and your Lord is Allah."</p></div>
                <div class="bg-ashes-900/50 p-4 rounded-xl border border-gray-700/50"><p class="text-[10px] text-gold-500 uppercase font-bold mb-2 tracking-widest">Suhoor (Intention)</p><p class="font-arabic text-xl text-right mb-2 leading-loose">ÙˆÙØ¨ÙØµÙÙˆÙ’Ù…Ù ØºÙØ¯Ù Ù†ÙÙ‘ÙˆÙÙŠÙ’ØªÙ Ù…ÙÙ†Ù’ Ø´ÙÙ‡Ù’Ø±Ù Ø±ÙÙ…ÙØ¶ÙØ§Ù†Ù</p><p class="text-xs text-gray-400 italic">"I intend to keep the fast for tomorrow in the month of Ramadan."</p></div>
                <div class="bg-ashes-900/50 p-4 rounded-xl border border-gray-700/50"><p class="text-[10px] text-gold-500 uppercase font-bold mb-2 tracking-widest">Iftar (Breaking Fast)</p><p class="font-arabic text-xl text-right mb-2 leading-loose">Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ù„ÙÙƒÙ ØµÙÙ…Ù’ØªÙ ÙˆÙØ¹ÙÙ„ÙÙ‰ Ø±ÙØ²Ù’Ù‚ÙÙƒÙ Ø£ÙÙÙ’Ø·ÙØ±Ù’ØªÙ</p><p class="text-xs text-gray-400 italic">"O Allah, I fasted for You and I break my fast with Your sustenance."</p></div>
                <div class="bg-ashes-900/50 p-4 rounded-xl border border-gray-700/50"><p class="text-[10px] text-gold-500 uppercase font-bold mb-2 tracking-widest">Iftar (As Guest)</p><p class="font-arabic text-xl text-right mb-2 leading-loose">Ø£ÙÙÙ’Ø·ÙØ±Ù Ø¹ÙÙ†Ù’Ø¯ÙÙƒÙÙ…Ù Ø§Ù„ØµÙÙ‘Ø§Ø¦ÙÙ…ÙÙˆÙ†ÙØŒ ÙˆÙØ£ÙÙƒÙÙ„Ù Ø·ÙØ¹ÙØ§Ù…ÙÙƒÙÙ…Ù Ø§Ù„Ù’Ø£ÙØ¨Ù’Ø±ÙØ§Ø±ÙØŒ ÙˆÙØµÙÙ„ÙÙ‘ØªÙ’ Ø¹ÙÙ„ÙÙŠÙ’ÙƒÙÙ…Ù Ø§Ù„Ù’Ù…ÙÙ„ÙØ§Ø¦ÙÙƒÙØ©Ù</p><p class="text-xs text-gray-400 italic">"May the fasting people break fasting at your place, and may the pious eat your food, and may the angels pray for you."</p></div>
                <div class="flex items-center gap-3 justify-center opacity-30 my-2"><div class="h-px w-10 bg-white"></div><span class="text-xs">Û</span><div class="h-px w-10 bg-white"></div></div>
                <div class="bg-ashes-900/50 p-4 rounded-xl border border-gray-700/50"><p class="text-[10px] text-gold-500 uppercase font-bold mb-2 tracking-widest">First Ashra (Mercy)</p><p class="font-arabic text-xl text-right mb-2 leading-loose">Ø±ÙØ¨ÙÙ‘ Ø§ØºÙ’ÙÙØ±Ù’ ÙˆÙØ§Ø±Ù’Ø­ÙÙ…Ù’ ÙˆÙØ£ÙÙ†Ù’ØªÙ Ø®ÙÙŠÙ’Ø±Ù Ø§Ù„Ø±ÙÙ‘Ø§Ø­ÙÙ…ÙÙŠÙ†Ù</p><p class="text-xs text-gray-400 italic">"O My Lord, forgive and have mercy, and You are the best of the Merciful."</p></div>
                <div class="bg-ashes-900/50 p-4 rounded-xl border border-gray-700/50"><p class="text-[10px] text-gold-500 uppercase font-bold mb-2 tracking-widest">Second Ashra (Forgiveness)</p><p class="font-arabic text-xl text-right mb-2 leading-loose">Ø£ÙØ³Ù’ØªÙØºÙ’ÙÙØ±Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø±ÙØ¨ÙÙ‘ÙŠ Ù…ÙÙ†Ù’ ÙƒÙÙ„ÙÙ‘ Ø°ÙÙ†Ù’Ø¨Ù ÙˆÙØ£ÙØªÙÙˆØ¨Ù Ø¥ÙÙ„ÙÙŠÙ’Ù‡Ù</p><p class="text-xs text-gray-400 italic">"I seek forgiveness from Allah, my Lord, from every sin, and I turn to Him in repentance."</p></div>
                <div class="bg-ashes-900/50 p-4 rounded-xl border border-gray-700/50"><p class="text-[10px] text-gold-500 uppercase font-bold mb-2 tracking-widest">Third Ashra (Protection)</p><p class="font-arabic text-xl text-right mb-2 leading-loose">Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø£ÙØ¬ÙØ±Ù’Ù†ÙÙŠ Ù…ÙÙ†Ù Ø§Ù„Ù†ÙÙ‘Ø§Ø±Ù</p><p class="text-xs text-gray-400 italic">"O Allah, save me from the Fire."</p></div>
                <div class="bg-ashes-900/50 p-4 rounded-xl border border-gray-700/50"><p class="text-[10px] text-gold-500 uppercase font-bold mb-2 tracking-widest">Laylatul Qadr</p><p class="font-arabic text-xl text-right mb-2 leading-loose">Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø¥ÙÙ†ÙÙ‘ÙƒÙ Ø¹ÙÙÙÙˆÙŒÙ‘ ØªÙØ­ÙØ¨ÙÙ‘ Ø§Ù„Ù’Ø¹ÙÙÙ’ÙˆÙ ÙÙØ§Ø¹Ù’ÙÙ Ø¹ÙÙ†ÙÙ‘ÙŠ</p><p class="text-xs text-gray-400 italic">"O Allah, You are Forgiving and love forgiveness, so forgive me."</p></div>
            </div>
        </div>
    </div>

    <!-- Tasbih Modal -->
    <div id="tasbihModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-md" onclick="app.closeTasbih()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-sm glass-panel p-8 rounded-3xl border border-gold-600/30 text-center animate-fadeIn">
            <h3 class="text-gold-500 font-serif text-2xl font-bold mb-1">Tasbih</h3>
            <div class="bg-black/40 rounded-full w-48 h-48 mx-auto flex items-center justify-center border-4 border-gray-800 mb-6 relative">
                <span id="tasbihCount" class="text-6xl font-mono font-bold text-white relative z-10">0</span>
                <div class="absolute inset-0 rounded-full border-t-2 border-gold-500/20 animate-spin-slow"></div>
            </div>
            <button onclick="app.tasbihClick()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 rounded-xl shadow-lg mb-3 text-lg transition-colors">COUNT</button>
            <button onclick="app.tasbihReset()" class="text-xs text-gray-500 hover:text-red-400 transition-colors">RESET COUNTER</button>
        </div>
    </div>

    <!-- Log Modal -->
    <div id="logModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/95 backdrop-blur-md transition-opacity" onclick="app.closeLogger()"></div>
        <div class="absolute bottom-0 md:top-1/2 md:left-1/2 md:transform md:-translate-x-1/2 md:-translate-y-1/2 md:bottom-auto w-full md:w-[500px] md:rounded-3xl bg-[#080808] border border-gray-800 shadow-2xl flex flex-col max-h-[90vh] animate-fadeIn ring-1 ring-white/5">
            <div class="p-6 border-b border-gray-800 flex justify-between items-center bg-ashes-900/50 rounded-t-3xl"><div><p class="font-arabic text-gold-500 text-xl">Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„ÙÙ‘Ù°Ù‡Ù</p><p class="text-[10px] text-gray-500 uppercase tracking-widest mt-1">Daily Log</p></div><button onclick="app.closeLogger()" class="text-gray-500 hover:text-white bg-ashes-800 w-8 h-8 rounded-full flex items-center justify-center transition-colors"><i class="fas fa-times"></i></button></div>
            <div class="overflow-y-auto p-6 space-y-8 flex-1 custom-scrollbar">
                <div><label class="block text-gray-500 text-[9px] uppercase font-bold mb-2 tracking-widest">Date</label><input type="date" id="logDate" class="w-full bg-ashes-900 border border-gray-800 rounded-xl p-4 text-white focus:border-gold-500 outline-none transition-colors appearance-none text-sm"></div>
                <div class="space-y-4">
                    <h4 class="text-white font-bold text-xs border-b border-gray-800 pb-2 uppercase tracking-widest flex items-center gap-2 text-gold-600"><i class="fas fa-star"></i> Obligations</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="p-4 bg-ashes-800/30 rounded-xl border border-gray-700/30 flex items-center justify-between hover:border-gold-600/30 transition-colors"><span class="text-gray-300 text-xs font-bold uppercase tracking-wide">Fasting</span><input type="checkbox" id="checkFast" class="w-5 h-5 accent-gold-500 cursor-pointer"></div>
                        <div class="p-4 bg-ashes-800/30 rounded-xl border border-gray-700/30 flex items-center justify-between hover:border-emerald-600/30 transition-colors"><span class="text-gray-300 text-xs font-bold uppercase tracking-wide">Charity</span><input type="checkbox" id="checkSadaqah" class="w-5 h-5 accent-emerald-500 cursor-pointer"></div>
                    </div>
                    <div>
                        <label class="block text-gray-500 text-[9px] uppercase font-bold mb-3 text-center tracking-widest">Prayers (Farz)</label>
                        <div class="grid grid-cols-5 gap-2">
                            <label class="cursor-pointer group"><input type="checkbox" class="peer sr-only prayer-check" value="Fajr"><div class="h-12 w-full rounded-xl bg-ashes-800 border border-gray-700 flex items-center justify-center text-gray-500 peer-checked:bg-emerald-900/20 peer-checked:border-emerald-500 peer-checked:text-emerald-400 transition-all font-bold text-[9px] uppercase">Fajr</div></label>
                            <label class="cursor-pointer group"><input type="checkbox" class="peer sr-only prayer-check" value="Dhuhr"><div class="h-12 w-full rounded-xl bg-ashes-800 border border-gray-700 flex items-center justify-center text-gray-500 peer-checked:bg-emerald-900/20 peer-checked:border-emerald-500 peer-checked:text-emerald-400 transition-all font-bold text-[9px] uppercase">Dhuhr</div></label>
                            <label class="cursor-pointer group"><input type="checkbox" class="peer sr-only prayer-check" value="Asr"><div class="h-12 w-full rounded-xl bg-ashes-800 border border-gray-700 flex items-center justify-center text-gray-500 peer-checked:bg-emerald-900/20 peer-checked:border-emerald-500 peer-checked:text-emerald-400 transition-all font-bold text-[9px] uppercase">Asr</div></label>
                            <label class="cursor-pointer group"><input type="checkbox" class="peer sr-only prayer-check" value="Maghrib"><div class="h-12 w-full rounded-xl bg-ashes-800 border border-gray-700 flex items-center justify-center text-gray-500 peer-checked:bg-emerald-900/20 peer-checked:border-emerald-500 peer-checked:text-emerald-400 transition-all font-bold text-[9px] uppercase">Mag</div></label>
                            <label class="cursor-pointer group"><input type="checkbox" class="peer sr-only prayer-check" value="Isha"><div class="h-12 w-full rounded-xl bg-ashes-800 border border-gray-700 flex items-center justify-center text-gray-500 peer-checked:bg-emerald-900/20 peer-checked:border-emerald-500 peer-checked:text-emerald-400 transition-all font-bold text-[9px] uppercase">Isha</div></label>
                        </div>
                    </div>
                </div>
                <div class="space-y-4">
                    <h4 class="text-white font-bold text-xs border-b border-gray-800 pb-2 uppercase tracking-widest flex items-center gap-2 text-gold-600"><i class="fas fa-book-open"></i> Quran</h4>
                    <div class="flex items-center gap-2 mb-4 bg-ashes-900 p-3 rounded-xl border border-gray-800"><span class="text-gray-300 text-xs font-bold uppercase tracking-wide flex-1 pl-2">Read Quran Today?</span><div class="flex gap-2"><button onclick="app.toggleQuran(true)" id="btnQuranYes" class="px-6 py-2 rounded-lg text-[10px] uppercase font-bold bg-ashes-800 border border-gray-700 text-gray-400 transition-all">Yes</button><button onclick="app.toggleQuran(false)" id="btnQuranNo" class="px-6 py-2 rounded-lg text-[10px] uppercase font-bold bg-ashes-800 border border-gray-700 text-gray-400 transition-all">No</button></div></div>
                    <div id="quranDetails" class="hidden space-y-4 bg-ashes-800/20 p-5 rounded-xl border border-gold-600/10 animate-fadeIn">
                        <div><label class="block text-gray-500 text-[9px] uppercase font-bold mb-2 tracking-widest">Surah</label><select id="surahSelect" class="w-full bg-ashes-900 border border-gray-700 rounded-xl p-3 text-white text-sm focus:border-gold-500 outline-none"></select><div id="customSurahContainer" class="hidden mt-2"><input type="text" id="customSurahInput" placeholder="Type Surah Name..." class="w-full bg-ashes-900 border border-gold-600/50 rounded-xl p-3 text-white text-sm focus:border-gold-500 outline-none"></div></div>
                        <div class="grid grid-cols-2 gap-3"><div><label class="block text-gray-500 text-[9px] uppercase font-bold mb-2 tracking-widest">Pages / Verses</label><input type="number" id="versesCount" class="w-full bg-ashes-900 border border-gray-700 rounded-xl p-3 text-white text-sm focus:border-gold-500 outline-none"></div><div><label class="block text-gray-500 text-[9px] uppercase font-bold mb-2 tracking-widest">Time</label><select id="readTime" class="w-full bg-ashes-900 border border-gray-700 rounded-xl p-3 text-white text-sm focus:border-gold-500 outline-none"><option value="Fajr">Fajr</option><option value="Noon">Noon</option><option value="Taraweeh">Taraweeh</option></select></div></div>
                        <div class="bg-gradient-to-br from-ashes-950 to-black p-4 rounded-xl border border-gold-900/30"><label class="flex items-center cursor-pointer mb-3"><input type="checkbox" id="checkTranslation" class="w-4 h-4 accent-gold-500" onchange="app.toggleTranslation()"><span class="ml-2 text-xs text-gold-400 font-bold uppercase tracking-wide">Read Translation/Tafseer</span></label><div id="verificationSection" class="hidden mt-2 pt-2 border-t border-gray-800"><label class="block text-[9px] text-emerald-500 mb-2 font-bold uppercase tracking-widest flex items-center gap-2"><i class="fas fa-pen-fancy"></i> Reflection (Required)</label><textarea id="reflectionInput" rows="2" placeholder="Briefly, what did you learn?" class="w-full bg-ashes-900/50 border border-gray-700 rounded-lg p-3 text-sm text-white focus:border-emerald-500 outline-none transition-colors placeholder-gray-600"></textarea><p class="text-[9px] text-gray-500 mt-1 text-right" id="charCount">0/10</p></div></div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-gray-800 bg-ashes-900/80 rounded-b-3xl"><button onclick="app.submitLog()" class="w-full bg-gradient-to-r from-gold-700 to-gold-500 hover:from-gold-600 hover:to-gold-400 text-black font-bold py-4 rounded-xl shadow-lg transition-all transform active:scale-[0.98] tracking-widest text-xs uppercase">SAVE RECORD</button></div>
        </div>
    </div>

    <div id="toast" class="fixed top-5 right-5 z-50 transform translate-x-full transition-transform duration-300"><div class="bg-ashes-800 border-l-4 border-gold-500 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center border border-gray-700/50"><i class="fas fa-check-circle text-gold-500 mr-3 text-xl"></i><div><h4 class="font-bold text-sm text-white">Success</h4><p class="text-xs text-gray-400" id="toastMsg">Action completed</p></div></div></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, linkWithPopup } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCF04TLqqjLz1olCsjaA3PdATwqbyd5aNw",
            authDomain: "ashes-trac.firebaseapp.com",
            projectId: "ashes-trac",
            storageBucket: "ashes-trac.firebasestorage.app",
            messagingSenderId: "1038049260529",
            appId: "1:1038049260529:web:401583810f6042562e8a50"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const teamGroupId = 'team-ashes-2025';
        const googleProvider = new GoogleAuthProvider();

        const setText = (id, val) => { const el = document.getElementById(id); if (el) el.innerText = val; };

        window.app = {
            state: { user: null, logs: [], leaderboard: [], khatamPage: 0, quranActive: false, tasbihCount: 0 },

            init: async function() {
                try { await signInAnonymously(auth); } catch (error) { console.error("Auth Failed", error); }
                onAuthStateChanged(auth, (user) => { 
                    if (user) { 
                        this.state.user = user; 
                        this.setupRealtimeListeners(user.uid);
                        const gBtn = document.getElementById('btnLinkGoogle');
                        if(gBtn) gBtn.classList.toggle('hidden', !user.isAnonymous);
                    } 
                });
                this.setupUI();
            },

            setupRealtimeListeners: function(userId) {
                const logsRef = collection(db, 'artifacts', teamGroupId, 'users', userId, 'logs');
                onSnapshot(logsRef, (snapshot) => {
                    this.state.logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.state.logs.sort((a, b) => new Date(b.date) - new Date(a.date));
                    window.app.renderDashboard(); // Fix: use window.app explicitly
                    window.app.renderLogs();      // Fix: use window.app explicitly
                }, (err) => { if(err.code === 'permission-denied') document.getElementById('errorModal').classList.remove('hidden'); });

                const lbRef = collection(db, 'artifacts', teamGroupId, 'public', 'data', 'leaderboard');
                onSnapshot(lbRef, (snapshot) => {
                    this.state.leaderboard = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
                    const myProfile = this.state.leaderboard.find(p => p.uid === userId);
                    if (myProfile) {
                        this.state.khatamPage = myProfile.khatamPage || 0;
                        document.getElementById('authScreen').classList.add('hidden');
                        document.getElementById('appScreen').classList.remove('hidden');
                        document.getElementById('appScreen').classList.add('fade-in');
                        setText('userDisplay', myProfile.name);
                        window.app.updateKhatamVisuals(myProfile.khatamPage); // Fix: use window.app explicitly
                    } else {
                        document.getElementById('authScreen').classList.remove('hidden');
                        document.getElementById('appScreen').classList.add('hidden');
                    }
                    window.app.renderLeaderboard(); // Fix: use window.app explicitly
                }, (err) => { if(err.code === 'permission-denied') document.getElementById('errorModal').classList.remove('hidden'); });
            },

            login: async function() {
                try {
                    const name = document.getElementById('usernameInput').value.trim();
                    if (!name) return alert("Please enter your name");
                    const btn = document.getElementById('loginBtn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> CONNECTING...';
                    if (!this.state.user) {
                        let tries = 0;
                        while(!this.state.user && tries < 5) { await new Promise(r => setTimeout(r, 1000)); tries++; }
                        if(!this.state.user) { btn.innerHTML = originalText; return alert("Connection slow. Please try again."); }
                    }
                    const userRef = doc(db, 'artifacts', teamGroupId, 'public', 'data', 'leaderboard', this.state.user.uid);
                    await setDoc(userRef, { name: name, score: 0, fasts: 0, khatamPage: 0, joinedAt: new Date().toISOString() }, { merge: true });
                } catch (error) {
                    document.getElementById('loginBtn').innerHTML = 'ENTER PORTAL';
                    if (error.code === 'permission-denied') document.getElementById('errorModal').classList.remove('hidden');
                    else alert(error.message);
                }
            },
            
            linkGoogle: async function() {
                if(!confirm("Link Google account to save progress?")) return;
                try {
                    const result = await linkWithPopup(auth.currentUser, googleProvider);
                    this.showToast("Account Linked!");
                    document.getElementById('btnLinkGoogle').classList.add('hidden');
                } catch (error) {
                    if (error.code === 'auth/credential-already-in-use') {
                        alert("Account already linked to another user. Sign out and sign in with Google.");
                    } else {
                        alert("Error: " + error.message);
                    }
                }
            },

            logout: function() { if(confirm("Log out?")) { auth.signOut(); location.reload(); } },

            submitLog: async function() {
                try {
                    if (!this.state.user) return;
                    const date = document.getElementById('logDate').value;
                    if(!date) return alert("Select date");
                    const existing = this.state.logs.find(l => l.date === date);
                    if(existing) { if(!confirm("Overwrite log?")) return; await deleteDoc(doc(db, 'artifacts', teamGroupId, 'users', this.state.user.uid, 'logs', existing.id)); }
                    
                    const fasted = document.getElementById('checkFast').checked;
                    const sadaqah = document.getElementById('checkSadaqah').checked;
                    const prayers = [];
                    document.querySelectorAll('.prayer-check:checked').forEach(cb => prayers.push(cb.value));
                    
                    let quranData = null;
                    if (this.state.quranActive) {
                        let surah = document.getElementById('surahSelect').value;
                        if(surah === 'Other') surah = document.getElementById('customSurahInput').value.trim();
                        const verses = document.getElementById('versesCount').value;
                        const time = document.getElementById('readTime').value;
                        const translation = document.getElementById('checkTranslation').checked;
                        const reflection = document.getElementById('reflectionInput').value.trim();
                        if (!surah && (!verses || verses == 0)) return alert("Please specify Surah or Pages.");
                        if (translation && reflection.length < 10) return alert("Verification Failed: Write a reflection.");
                        quranData = { surah, verses, time, translation, reflection };
                    }
                    await addDoc(collection(db, 'artifacts', teamGroupId, 'users', this.state.user.uid, 'logs'), { date, fasted, sadaqah, prayers, quran: quranData, timestamp: new Date().toISOString() });
                    const tempLogs = [...this.state.logs.filter(l => l.date !== date), { fasted, sadaqah, prayers, quran: quranData }];
                    await this.updateProfile(tempLogs, this.state.khatamPage);
                    this.closeLogger();
                    this.showToast("Saved!");
                } catch (error) { if (error.code === 'permission-denied') document.getElementById('errorModal').classList.remove('hidden'); else alert(error.message); }
            },

            deleteLog: async function(id) { try { if(!confirm("Delete entry?")) return; await deleteDoc(doc(db, 'artifacts', teamGroupId, 'users', this.state.user.uid, 'logs', id)); const tempLogs = this.state.logs.filter(l => l.id !== id); await this.updateProfile(tempLogs, this.state.khatamPage); this.showToast("Deleted"); } catch (error) { if (error.code === 'permission-denied') document.getElementById('errorModal').classList.remove('hidden'); } },

            saveKhatam: async function() { try { const val = document.getElementById('khatamSlider').value; this.state.khatamPage = val; await this.updateProfile(this.state.logs, val); this.showToast("Khatam Updated"); } catch (error) { if (error.code === 'permission-denied') document.getElementById('errorModal').classList.remove('hidden'); } },
            
            adjustKhatam: function(amount) {
                const slider = document.getElementById('khatamSlider');
                let val = parseInt(slider.value) || 0;
                val = Math.min(604, Math.max(0, val + amount));
                slider.value = val;
                this.handleKhatamSlide(val);
            },

            handleKhatamSlide: function(val) {
                setText('khatamCurrentDisplay', val);
                const p = Math.round((val/604)*100);
                setText('khatamPercent', `${p}% Completed`);
                
                const bar = document.getElementById('khatamBar'); 
                if(bar) bar.style.width = `${p}%`;
                
                const trackFill = document.getElementById('khatamTrackFill');
                if(trackFill) trackFill.style.width = `${p}%`;
                
                const thumb = document.getElementById('khatamThumb');
                if(thumb) thumb.style.left = `${p}%`;
            },

            updateProfile: async function(logs, khatam) {
                let score = 0; let fasts = 0;
                logs.forEach(l => { if (l.fasted) { score += 50; fasts++; } if (l.prayers) score += (l.prayers.length * 10); if (l.sadaqah) score += 20; if (l.quran) { score += 20; if (l.quran.translation) score += 15; } });
                score += (parseInt(khatam || 0) * 2);
                const userRef = doc(db, 'artifacts', teamGroupId, 'public', 'data', 'leaderboard', this.state.user.uid);
                await setDoc(userRef, { score, fasts, khatamPage: parseInt(khatam) }, { merge: true });
            },

            calculateStreak: function(logs) {
                if(!logs.length) return 0;
                const uniqueDates = [...new Set(logs.map(l=>l.date))].sort((a,b)=>new Date(b)-new Date(a));
                const today = new Date().toISOString().split('T')[0];
                const yest = new Date(Date.now()-86400000).toISOString().split('T')[0];
                if(uniqueDates[0] !== today && uniqueDates[0] !== yest) return 0;
                let streak = 1;
                for(let i=0; i<uniqueDates.length-1; i++) { const diff = (new Date(uniqueDates[i]) - new Date(uniqueDates[i+1])) / (1000*60*60*24); if(Math.ceil(diff) === 1) streak++; else break; }
                return streak;
            },

            calculateTotalScore: function(logs, khatamPage) {
                let score = 0;
                logs.forEach(l => { if (l.fasted) score += 50; if (l.prayers) score += (l.prayers.length * 10); if (l.sadaqah) score += 20; if (l.quran) { score += 20; if (l.quran.translation) score += 15; } });
                score += (parseInt(khatam || 0) * 2);
                return score;
            },

            setupUI: function() {
                const surahList = ["Al-Fatiha", "Al-Baqarah", "Al-Imran", "An-Nisa", "Al-Ma'idah", "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Tawbah", "Yunus", "Hud", "Yusuf", "Ar-Ra'd", "Ibrahim", "Al-Hijr", "An-Nahl", "Al-Isra", "Al-Kahf", "Maryam", "Ta-Ha", "Al-Anbiya", "Al-Hajj", "Al-Mu'minun", "An-Nur", "Al-Furqan", "Ash-Shu'ara", "An-Naml", "Al-Qasas", "Al-Ankabut", "Ar-Rum", "Luqman", "As-Sajdah", "Al-Ahzab", "Saba", "Fatir", "Ya-Sin", "As-Saffat", "Sad", "Az-Zumar", "Ghafir", "Fussilat", "Ash-Shura", "Az-Zukhruf", "Ad-Dukhan", "Al-Jathiyah", "Al-Ahqaf", "Muhammad", "Al-Fath", "Al-Hujurat", "Qaf", "Adh-Dhariyat", "At-Tur", "An-Najm", "Al-Qamar", "Ar-Rahman", "Al-Waqi'ah", "Al-Hadid", "Al-Mujadila", "Al-Hashr", "Al-Mumtahanah", "As-Saff", "Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "At-Talaq", "At-Tahrim", "Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij", "Nuh", "Al-Jinn", "Al-Muzzammil", "Al-Muddaththir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat", "An-Naba", "An-Nazi'at", "Abasa", "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Inshiqaq", "Al-Buruj", "At-Tariq", "Al-A'la", "Al-Ghashiyah", "Al-Fajr", "Al-Balad", "Ash-Shams", "Al-Layl", "Ad-Duhaa", "Ash-Sharh", "At-Tin", "Al-Alaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-Adiyat", "Al-Qari'ah", "At-Takathur", "Al-Asr", "Al-Humazah", "Al-Fil", "Quraysh", "Al-Ma'un", "Al-Kawthar", "Al-Kafirun", "An-Nasr", "Al-Masad", "Al-Ikhlas", "Al-Falaq", "An-Nas"];
                const s = document.getElementById('surahSelect');
                if(!s) return; 
                s.innerHTML = '<option value="">Select Surah...</option>';
                surahList.forEach((n,i)=> s.innerHTML += `<option value="${n}">${i+1}. ${n}</option>`);
                s.innerHTML += '<option value="Other">Other / Type Name</option>';

                const logDate = document.getElementById('logDate');
                if(logDate) logDate.value = new Date().toISOString().split('T')[0];
                
                // Expanded Verse List
                const vs = [ 
                    { ar: "ÙÙØ¥ÙÙ†ÙÙ‘ Ù…ÙØ¹Ù Ù±Ù„Ù’Ø¹ÙØ³Ù’Ø±Ù ÙŠÙØ³Ù’Ø±Ù‹Ø§", en: "For indeed, with hardship [will be] ease. (94:5)" },
                    { ar: "Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù†ÙÙˆØ±Ù Ù±Ù„Ø³ÙÙ‘Ù…ÙÙ°ÙˆÙÙ°ØªÙ ÙˆÙÙ±Ù„Ù’Ø£ÙØ±Ù’Ø¶Ù", en: "Allah is the Light of the heavens and the earth. (24:35)" },
                    { ar: "ÙˆÙÙ‚ÙÙ„ Ø±ÙÙ‘Ø¨ÙÙ‘ Ø²ÙØ¯Ù’Ù†ÙÙ‰ Ø¹ÙÙ„Ù’Ù…Ù‹Ø§", en: "And say, 'My Lord, increase me in knowledge.' (20:114)" },
                    { ar: "ÙÙÙ±Ø°Ù’ÙƒÙØ±ÙÙˆÙ†ÙÙ‰Ù“ Ø£ÙØ°Ù’ÙƒÙØ±Ù’ÙƒÙÙ…Ù’", en: "So remember Me; I will remember you. (2:152)" },
                    { ar: "Ø¥ÙÙ†ÙÙ‘ Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù…ÙØ¹Ù Ù±Ù„ØµÙÙ‘Ù°Ø¨ÙØ±ÙÙŠÙ†Ù", en: "Indeed, Allah is with the patient. (2:153)" },
                    { ar: "Ø£ÙÙ„ÙØ§ Ø¨ÙØ°ÙÙƒÙ’Ø±Ù Ù±Ù„Ù„ÙÙ‘Ù‡Ù ØªÙØ·Ù’Ù…ÙØ¦ÙÙ†ÙÙ‘ Ù±Ù„Ù’Ù‚ÙÙ„ÙÙˆØ¨Ù", en: "Unquestionably, by the remembrance of Allah do hearts find rest. (13:28)" },
                    { ar: "ÙˆÙÙ‚ÙØ§Ù„Ù Ø±ÙØ¨ÙÙ‘ÙƒÙÙ…Ù Ù±Ø¯Ù’Ø¹ÙÙˆÙ†ÙÙ‰Ù“ Ø£ÙØ³Ù’ØªÙØ¬ÙØ¨Ù’ Ù„ÙÙƒÙÙ…Ù’", en: "And your Lord says, 'Call upon Me; I will respond to you.' (40:60)" },
                    { ar: "Ù„ÙØ¦ÙÙ† Ø´ÙÙƒÙØ±Ù’ØªÙÙ…Ù’ Ù„ÙØ£ÙØ²ÙÙŠØ¯ÙÙ†ÙÙ‘ÙƒÙÙ…Ù’", en: "If you are grateful, I will surely increase you [in favor]. (14:7)" },
                    { ar: "ÙˆÙÙ‡ÙÙˆÙ Ù…ÙØ¹ÙÙƒÙÙ…Ù’ Ø£ÙÙŠÙ’Ù†Ù Ù…ÙØ§ ÙƒÙÙ†ØªÙÙ…Ù’", en: "And He is with you wherever you are. (57:4)" },
                    { ar: "Ø¥ÙÙ†ÙÙ‘ Ø±ÙØ­Ù’Ù…ÙØªÙ Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù‚ÙØ±ÙÙŠØ¨ÙŒ Ù…ÙÙ‘Ù†Ù Ù±Ù„Ù’Ù…ÙØ­Ù’Ø³ÙÙ†ÙÙŠÙ†Ù", en: "Indeed, the mercy of Allah is near to the doers of good. (7:56)" },
                    { ar: "Ù‚ÙÙ„Ù’ ÙŠÙÙ°Ø¹ÙØ¨ÙØ§Ø¯ÙÙ‰Ù Ù±Ù„ÙÙ‘Ø°ÙÙŠÙ†Ù Ø£ÙØ³Ù’Ø±ÙÙÙÙˆØ§ÛŸ Ø¹ÙÙ„ÙÙ‰Ù°Ù“ Ø£ÙÙ†ÙÙØ³ÙÙ‡ÙÙ…Ù’ Ù„ÙØ§ ØªÙÙ‚Ù’Ù†ÙØ·ÙÙˆØ§ÛŸ Ù…ÙÙ† Ø±ÙÙ‘Ø­Ù’Ù…ÙØ©Ù Ù±Ù„Ù„ÙÙ‘Ù‡Ù", en: "Say, 'O My servants who have transgressed against themselves, do not despair of the mercy of Allah.' (39:53)" },
                    { ar: "ÙˆÙÙ…ÙÙ† ÙŠÙØªÙÙˆÙÙƒÙÙ‘Ù„Ù’ Ø¹ÙÙ„ÙÙ‰ Ù±Ù„Ù„ÙÙ‘Ù‡Ù ÙÙÙ‡ÙÙˆÙ Ø­ÙØ³Ù’Ø¨ÙÙ‡ÙÛ¥", en: "And whoever relies upon Allah - then He is sufficient for him. (65:3)" },
                    { ar: "Ø¥ÙÙ†ÙÙ‘ Ù±Ù„Ù„ÙÙ‘Ù‡Ù ÙŠÙØ­ÙØ¨ÙÙ‘ Ù±Ù„Ù’Ù…ÙØªÙÙˆÙÙƒÙÙ‘Ù„ÙÙŠÙ†Ù", en: "Indeed, Allah loves those who rely [upon Him]. (3:159)" },
                    { ar: "ÙˆÙØ¥ÙØ°ÙØ§ Ø³ÙØ£ÙÙ„ÙÙƒÙ Ø¹ÙØ¨ÙØ§Ø¯ÙÙ‰ Ø¹ÙÙ†ÙÙ‘Ù‰ ÙÙØ¥ÙÙ†ÙÙ‘Ù‰ Ù‚ÙØ±ÙÙŠØ¨ÙŒ", en: "And when My servants ask you concerning Me - indeed I am near. (2:186)" },
                    { ar: "Ù„ÙØ§ ÙŠÙÙƒÙÙ„ÙÙ‘ÙÙ Ù±Ù„Ù„ÙÙ‘Ù‡Ù Ù†ÙÙÙ’Ø³Ù‹Ø§ Ø¥ÙÙ„ÙÙ‘Ø§ ÙˆÙØ³Ù’Ø¹ÙÙ‡ÙØ§", en: "Allah does not charge a soul except [with that within] its capacity. (2:286)" },
                    { ar: "Ø¥ÙÙ†ÙÙ‘Ù…ÙØ§ ÙŠÙÙˆÙÙÙÙ‘Ù‰ Ù±Ù„ØµÙÙ‘Ù°Ø¨ÙØ±ÙÙˆÙ†Ù Ø£ÙØ¬Ù’Ø±ÙÙ‡ÙÙ… Ø¨ÙØºÙÙŠÙ’Ø±Ù Ø­ÙØ³ÙØ§Ø¨Ù", en: "Indeed, the patient will be given their reward without account. (39:10)" },
                    { ar: "ÙˆÙÙ±Ø³Ù’ØªÙØ¹ÙÙŠÙ†ÙÙˆØ§ÛŸ Ø¨ÙÙ±Ù„ØµÙÙ‘Ø¨Ù’Ø±Ù ÙˆÙÙ±Ù„ØµÙÙ‘Ù„ÙÙˆÙ°Ø©Ù", en: "And seek help through patience and prayer. (2:45)" },
                    { ar: "Ø±ÙØ¨ÙÙ‘Ù†ÙØ¢ Ø¡ÙØ§ØªÙÙ†ÙØ§ ÙÙÙ‰ Ù±Ù„Ø¯ÙÙ‘Ù†Ù’ÙŠÙØ§ Ø­ÙØ³ÙÙ†ÙØ©Ù‹ ÙˆÙÙÙÙ‰ Ù±Ù„Ù’Ù€ÙÙ”Ø§Ø®ÙØ±ÙØ©Ù Ø­ÙØ³ÙÙ†ÙØ©Ù‹", en: "Our Lord, give us in this world [that which is] good and in the Hereafter [that which is] good. (2:201)" }
                ];
                const r = vs[Math.floor(Math.random()*vs.length)];
                setText('dailyArabic', r.ar);
                setText('dailyEnglish', r.en);

                s.addEventListener('change', (e) => {
                    const customContainer = document.getElementById('customSurahContainer');
                    if(customContainer) customContainer.classList.toggle('hidden', e.target.value !== 'Other');
                });
                
                document.getElementById('reflectionInput').addEventListener('input', (e) => {
                    const c = e.target.value.length;
                    const el = document.getElementById('charCount');
                    if(el) { el.innerText = `${c}/10 chars`; el.style.color = c >= 10 ? '#34d399' : '#6b7280'; }
                });
            },

            updateKhatamVisuals: function(val) {
                if (val === undefined) val = this.state.khatamPage;
                setText('khatamCurrentDisplay', val);
                const slider = document.getElementById('khatamSlider'); if(slider) slider.value = val;
                const p = Math.round((val/604)*100);
                setText('khatamPercent', `${p}% Completed`);
                const bar = document.getElementById('khatamBar'); if(bar) bar.style.width = `${p}%`;
            },

            renderDashboard: function() {
                const fasts = this.state.logs.filter(l => l.fasted).length;
                let prayers = 0; this.state.logs.forEach(l => prayers += (l.prayers ? l.prayers.length : 0));
                const tp = this.state.logs.length * 5;
                const sp = tp > 0 ? Math.round((prayers/tp)*100) : 0;
                const streak = this.calculateStreak(this.state.logs);
                const myProfile = this.state.leaderboard.find(p => p.uid === this.state.user?.uid);
                const score = myProfile ? myProfile.score : 0;

                setText('statFasts', fasts);
                setText('statSalah', `${sp}%`);
                setText('statStreak', streak);
                setText('statPoints', score.toLocaleString());
            },

            renderLeaderboard: function() {
                const b = document.getElementById('leaderboardBody'); if(!b) return;
                b.innerHTML = '';
                const d = [...this.state.leaderboard].sort((a,b) => b.score - a.score);
                d.forEach((u, i) => {
                    const isMe = this.state.user && u.uid === this.state.user.uid;
                    const rank = i+1;
                    let c = 'text-gray-500 font-bold';
                    let icon = '';
                    if(rank===1) { c='text-gold-400 font-bold'; icon='<i class="fas fa-crown text-gold-500 ml-2 text-xs"></i>'; }
                    if(rank===2) { c='text-gray-300 font-bold'; }
                    if(rank===3) { c='text-orange-400 font-bold'; }
                    const rowClass = isMe ? 'bg-gold-600/10 border-l-4 border-l-gold-500 border-b border-gray-800/50' : 'border-b border-gray-800/50 hover:bg-ashes-800/40';
                    b.innerHTML += `<tr class="${rowClass} transition-colors"><td class="px-5 py-4 font-mono ${c}">#${rank}</td><td class="px-5 py-4 text-white font-medium flex items-center">${u.name} ${icon} ${isMe ? '<span class="ml-2 px-1.5 py-0.5 rounded border border-gold-600/30 bg-gold-600/20 text-gold-400 text-[9px] font-bold">YOU</span>' : ''}</td><td class="px-5 py-4 text-center text-gray-400 text-xs font-mono">${u.fasts || 0}</td><td class="px-5 py-4 text-right font-mono text-gold-500 font-bold">${(u.score||0).toLocaleString()}</td></tr>`;
                });
            },

            renderLogs: function() {
                const c = document.getElementById('logsContainer'); if(!c) return;
                c.innerHTML = '';
                if(this.state.logs.length === 0) { c.innerHTML = `<div class="glass-panel p-8 rounded-2xl text-center border-dashed border border-gray-800 opacity-60"><i class="fas fa-scroll text-3xl mb-3 text-gray-600"></i><p class="text-xs text-gray-500">Your legacy begins with the first log.</p></div>`; return; }
                this.state.logs.forEach(l => {
                    const d = new Date(l.date);
                    const day = d.getDate();
                    const month = d.toLocaleString('default', {month:'short'});
                    const badges = `${l.fasted ? '<span class="text-[9px] font-bold bg-emerald-900/30 text-emerald-400 px-2 py-0.5 rounded border border-emerald-900/50">FASTED</span>' : ''} ${l.sadaqah ? '<span class="text-[9px] font-bold bg-gold-900/20 text-gold-400 px-2 py-0.5 rounded border border-gold-600/20"><i class="fas fa-hand-holding-heart"></i></span>' : ''} ${l.quran ? '<span class="text-[9px] font-bold bg-blue-900/20 text-blue-400 px-2 py-0.5 rounded border border-blue-600/20"><i class="fas fa-quran"></i></span>' : ''}`;
                    c.innerHTML += `<div class="glass-panel p-4 rounded-2xl border-l-4 ${l.fasted?'border-l-gold-500':'border-l-gray-700'} flex justify-between items-center group hover:bg-ashes-800/40 transition-colors"><div class="flex items-center gap-4"><div class="bg-ashes-900/80 w-12 h-12 rounded-xl flex flex-col items-center justify-center border border-gray-800"><span class="text-[9px] text-gray-500 uppercase font-bold tracking-wider">${month}</span><span class="text-xl font-bold text-white leading-none font-serif">${day}</span></div><div><div class="flex gap-2 mb-1.5">${badges}</div><div class="text-emerald-400 text-[10px] font-bold"><i class="fas fa-pray"></i> ${l.prayers ? l.prayers.length : 0}/5 Prayers</div></div></div><button onclick="app.deleteLog('${l.id}')" class="text-gray-600 hover:text-red-500 p-2 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fas fa-trash"></i></button></div>`;
                });
            },

            openLogger: function() {
                document.getElementById('logModal').classList.remove('hidden');
                document.getElementById('checkFast').checked = false;
                document.getElementById('checkSadaqah').checked = false;
                document.querySelectorAll('.prayer-check').forEach(c => c.checked = false);
                this.toggleQuran(false);
                document.getElementById('checkTranslation').checked = false;
                this.toggleTranslation();
                document.getElementById('versesCount').value = '';
                document.getElementById('reflectionInput').value = '';
                document.getElementById('surahSelect').value = '';
            },
            closeLogger: function() { document.getElementById('logModal').classList.add('hidden'); },
            toggleQuran: function(active) {
                this.state.quranActive = active;
                document.getElementById('quranDetails').classList.toggle('hidden', !active);
                document.getElementById('btnQuranYes').className = active ? "px-5 py-2 rounded-lg text-xs font-bold bg-gold-600 text-black shadow-lg" : "px-5 py-2 rounded-lg text-xs font-bold bg-ashes-800 border border-gray-700 text-gray-500";
                document.getElementById('btnQuranNo').className = !active ? "px-5 py-2 rounded-lg text-xs font-bold bg-gray-700 text-white shadow-lg" : "px-5 py-2 rounded-lg text-xs font-bold bg-ashes-800 border border-gray-700 text-gray-500";
            },
            toggleTranslation: function() {
                const c = document.getElementById('checkTranslation').checked;
                document.getElementById('verificationSection').classList.toggle('hidden', !c);
            },
            scrollToSection: function(id) { document.getElementById(id).scrollIntoView({behavior:'smooth'}); },
            showToast: function(msg) {
                const t = document.getElementById('toast');
                setText('toastMsg', msg);
                t.classList.remove('translate-x-full');
                setTimeout(() => t.classList.add('translate-x-full'), 3000);
            },
            openTasbih: function() { document.getElementById('tasbihModal').classList.remove('hidden'); this.state.tasbihCount=0; setText('tasbihCount', 0); },
            closeTasbih: function() { document.getElementById('tasbihModal').classList.add('hidden'); },
            tasbihClick: function() { this.state.tasbihCount++; setText('tasbihCount', this.state.tasbihCount); if(navigator.vibrate) navigator.vibrate(20); },
            tasbihReset: function() { if(confirm("Reset?")) { this.state.tasbihCount=0; setText('tasbihCount', 0); } },
            openDuas: function() { document.getElementById('duasModal').classList.remove('hidden'); },
            closeDuas: function() { document.getElementById('duasModal').classList.add('hidden'); }
        };

        document.addEventListener('DOMContentLoaded', () => window.app.init());
    </script>
</body>
</html>
